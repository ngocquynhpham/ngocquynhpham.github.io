<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML Transformer - StudyX</title>

    <!-- SEO Meta Tags -->
    <meta name="description" content="Convert HTML to Markdown, Plain Text & Rich Text. Auto-format HTML included.">
    <link href="./logo.ico" rel="icon" />

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/turndown/dist/turndown.js"></script>
    <!-- Thư viện làm đẹp HTML -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.7/beautify-html.min.js"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markdown.min.js"></script>
    
    <style>
        body { font-family: 'Inter', system-ui, sans-serif; background-color: #f8fafc; }
        .editor-container { height: calc(100vh - 125px); }
        textarea { resize: none; transition: opacity 0.2s; } /* Thêm transition cho hiệu ứng nháy */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        
        .rich-text-content h1 { font-size: 1.8em; font-weight: bold; margin-bottom: 0.5em; color: #e2e8f0; }
        .rich-text-content p { margin-bottom: 1em; line-height: 1.6; }
        .rich-text-content a { color: #3b82f6; text-decoration: underline; }

        .resizer {
            background-color: #1e293b; cursor: col-resize; width: 8px;
            display: flex; align-items: center; justify-content: center;
            border-left: 1px solid #334155; border-right: 1px solid #334155; z-index: 20;
        }
        .resizer:hover { background-color: #3b82f6; border-color: #3b82f6; }
        @media (max-width: 768px) {
            .resizer { display: none !important; }
            .editor-panel { width: 100% !important; height: 50%; }
            .editor-container { flex-direction: column; }
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden text-slate-800">

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 px-4 py-3 flex items-center justify-between shadow-sm z-10 shrink-0">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 text-white p-1.5 rounded-lg">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline></svg>
            </div>
            <div>
                <h1 class="font-bold text-base md:text-lg text-slate-900 tracking-tight">HTML Transformer</h1>
                <p class="text-[10px] md:text-xs text-slate-500 font-medium hidden sm:block">HTML to Markdown & Text</p>
            </div>
        </div>

        <div class="flex gap-2">
            <button type="button" onclick="handleClear()" class="px-3 py-1.5 text-xs md:text-sm font-medium text-slate-600 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors flex items-center gap-1.5">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
                <span class="hidden sm:inline">Clear</span>
            </button>
            <button type="button" onclick="copyOutput()" id="btn-copy" class="px-3 py-1.5 text-xs md:text-sm font-bold text-white bg-blue-600 hover:bg-blue-700 rounded-lg shadow-sm transition-all flex items-center gap-1.5">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                Copy <span class="hidden sm:inline">Result</span>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main id="main-container" class="flex-1 flex bg-slate-900 editor-container w-full">
        <!-- LEFT PANEL -->
        <div id="left-panel" class="editor-panel flex flex-col" style="width: 50%;">
            <div class="bg-slate-800 px-4 py-2 flex justify-between items-center border-b border-slate-700 h-10 shrink-0">
                <div class="flex items-center gap-3">
                    <span class="text-[10px] md:text-xs font-bold text-blue-400 uppercase tracking-wider flex items-center gap-2">
                        Input (HTML)
                    </span>
                    <!-- Format Button (Vẫn giữ để bấm tay nếu thích) -->
                    <button type="button" onclick="formatHTML()" class="text-[10px] font-bold text-yellow-400 hover:text-yellow-300 transition-colors flex items-center gap-1" title="Tự động căn chỉnh code">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                        Format
                    </button>
                </div>
                <span class="text-[10px] text-slate-500" id="char-count">0 chars</span>
            </div>
            <!-- Added placeholder instruction -->
            <textarea id="input-html" class="flex-1 w-full bg-[#1e293b] text-slate-300 p-4 font-mono text-sm focus:outline-none focus:ring-0 placeholder-slate-600 leading-relaxed" placeholder="<!-- Paste your HTML here... It will AUTO-FORMAT! -->" oninput="handleConvert()"></textarea>
        </div>

        <!-- RESIZER -->
        <div id="resizer" class="resizer" title="Drag to resize"></div>

        <!-- RIGHT PANEL -->
        <div id="right-panel" class="editor-panel flex flex-col bg-[#0f172a]" style="width: 50%;">
            <div class="bg-slate-800 px-2 flex items-center border-b border-slate-700 gap-1 overflow-x-auto h-10 shrink-0 no-scrollbar">
                <button type="button" onclick="setMode('markdown')" id="tab-markdown" class="px-3 py-1 text-xs font-bold rounded text-white bg-slate-700 transition-colors">Markdown</button>
                <button type="button" onclick="setMode('text')" id="tab-text" class="px-3 py-1 text-xs font-bold rounded text-slate-400 hover:text-slate-200 transition-colors">Text</button>
                <button type="button" onclick="setMode('richtext')" id="tab-richtext" class="px-3 py-1 text-xs font-bold rounded text-slate-400 hover:text-slate-200 transition-colors">Rich Text</button>
            </div>
            <div class="relative flex-1 group overflow-hidden">
                <textarea id="output-result" class="hidden"></textarea>
                <pre id="preview-container" class="m-0 h-full w-full p-4 overflow-auto bg-[#0f172a] text-sm font-mono"><code id="preview-code" class="language-markdown"></code></pre>
                <div id="preview-richtext" class="hidden m-0 h-full w-full p-6 overflow-auto bg-[#0f172a] text-slate-300 rich-text-content font-sans"></div>
                <div id="copy-toast" class="absolute top-4 right-4 bg-green-500 text-white text-xs font-bold px-3 py-1.5 rounded opacity-0 transition-opacity pointer-events-none z-20">Copied!</div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-slate-800 text-slate-500 text-[10px] md:text-xs py-2 px-4 flex justify-between items-center border-t border-slate-700 shrink-0">
        <div>StudyX Ecosystem</div>
        <div><span id="status-indicator" class="inline-block w-2 h-2 rounded-full bg-green-500 mr-1"></span> Ready</div>
    </footer>

    <script>
        const inputEl = document.getElementById('input-html');
        const outputEl = document.getElementById('output-result');
        const previewEl = document.getElementById('preview-code');
        const previewContainer = document.getElementById('preview-container');
        const previewRich = document.getElementById('preview-richtext');
        const tabs = { markdown: document.getElementById('tab-markdown'), text: document.getElementById('tab-text'), richtext: document.getElementById('tab-richtext') };
        const charCountEl = document.getElementById('char-count');
        const statusIndicator = document.getElementById('status-indicator');
        
        let turndownService;
        let currentMode = 'markdown';

        try {
            turndownService = new TurndownService({ headingStyle: 'atx', codeBlockStyle: 'fenced' });
        } catch (e) {
            console.error("TurndownService failed:", e);
            statusIndicator.classList.replace('bg-green-500', 'bg-red-500');
        }

        // --- NEW: AUTO-FORMAT ON PASTE ---
        inputEl.addEventListener('paste', () => {
            // Chờ 50ms để text paste vào xong xuôi
            setTimeout(() => {
                formatHTML();
                // Hiệu ứng "Nháy" nhẹ để user biết đã format
                inputEl.style.opacity = '0.5';
                setTimeout(() => inputEl.style.opacity = '1', 150);
            }, 50);
        });

        function formatHTML() {
            const rawHtml = inputEl.value;
            if(!rawHtml) return;
            
            if(window.html_beautify) {
                const formatted = html_beautify(rawHtml, {
                    "indent_size": 2,
                    "indent_char": " ",
                    "max_preserve_newlines": 1,
                    "preserve_newlines": true,
                    "indent_scripts": "keep",
                    "end_with_newline": true,
                    "wrap_line_length": 0
                });
                inputEl.value = formatted;
                handleConvert(); 
            }
        }

        function handleConvert() {
            const html = inputEl.value;
            charCountEl.innerText = `${html.length} chars`;

            if (!html.trim()) { 
                outputEl.value = ''; previewEl.innerHTML = ''; previewRich.innerHTML = ''; return; 
            }

            let result = '';
            if (currentMode === 'markdown') {
                try {
                    result = turndownService ? turndownService.turndown(html) : "Error: Library not loaded.";
                } catch (e) { result = "Error: " + e.message; }
                updateCodePreview(result, 'language-markdown');
            } else if (currentMode === 'text') {
                const doc = new DOMParser().parseFromString(html, 'text/html');
                result = (doc.body.textContent || "").replace(/\n\s*\n/g, '\n').trim();
                updateCodePreview(result, 'language-text');
            } else if (currentMode === 'richtext') {
                previewRich.innerHTML = html;
            }
        }

        function updateCodePreview(content, langClass) {
            outputEl.value = content;
            previewEl.className = langClass;
            previewEl.innerHTML = content.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            if (window.Prism) Prism.highlightElement(previewEl);
        }

        window.handleClear = function() {
            console.log("Clear button clicked!");
            if(confirm("Xóa toàn bộ nội dung?")) { 
                inputEl.value = ''; 
                handleConvert(); 
            } 
        }

        window.setMode = function(mode) {
            currentMode = mode;
            const baseClass = "px-3 py-1 text-xs font-bold rounded transition-colors whitespace-nowrap";
            Object.values(tabs).forEach(t => t.className = `${baseClass} text-slate-400 hover:text-slate-200`);
            tabs[mode].className = `${baseClass} text-white bg-slate-700`;

            if (mode === 'richtext') {
                previewContainer.classList.add('hidden'); previewRich.classList.remove('hidden');
            } else {
                previewContainer.classList.remove('hidden'); previewRich.classList.add('hidden');
            }
            handleConvert();
        }

        window.copyOutput = async function() {
            try {
                if (currentMode === 'richtext') {
                    const blobHtml = new Blob([inputEl.value], { type: 'text/html' });
                    const blobText = new Blob([previewRich.innerText], { type: 'text/plain' });
                    await navigator.clipboard.write([new ClipboardItem({ 'text/html': blobHtml, 'text/plain': blobText })]);
                    showToast("Copied Formatted!");
                } else {
                    if (!outputEl.value) return;
                    await navigator.clipboard.writeText(outputEl.value);
                    showToast("Copied!");
                }
            } catch(e) {
                console.error(e);
                showToast("Error Copying");
            }
        }

        function showToast(msg) {
            const toast = document.getElementById('copy-toast');
            toast.innerText = msg;
            toast.classList.remove('opacity-0');
            setTimeout(() => toast.classList.add('opacity-0'), 2000);
        }

        const resizer = document.getElementById('resizer');
        const leftPanel = document.getElementById('left-panel');
        const rightPanel = document.getElementById('right-panel');
        const container = document.getElementById('main-container');
        let isResizing = false;

        resizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            document.body.style.cursor = 'col-resize';
            leftPanel.style.userSelect = 'none';
            rightPanel.style.userSelect = 'none';
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            const containerRect = container.getBoundingClientRect();
            const newLeftWidth = ((e.clientX - containerRect.left) / containerRect.width) * 100;
            if (newLeftWidth > 20 && newLeftWidth < 80) {
                leftPanel.style.width = `${newLeftWidth}%`;
                rightPanel.style.width = `${100 - newLeftWidth}%`;
            }
        });

        document.addEventListener('mouseup', () => {
            isResizing = false;
            document.body.style.cursor = 'default';
            leftPanel.style.userSelect = 'auto';
            rightPanel.style.userSelect = 'auto';
        });

        window.onload = function() {
            if(!inputEl.value) {
                inputEl.value = `<h1>Welcome to StudyX</h1><p>Paste HTML here to see Magic!</p><ul><li>Auto Format</li><li>Instant Convert</li></ul>`;
                handleConvert();
            }
        }
    </script>
</body>
</html>